<!DOCTYPE html>
<html>
<head>
    <title>å®Œæ•´å±æ€§å¯¹æˆ˜æ¸¸æˆ</title>
    <style>
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        .score-board {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .battle-field {
            display: flex;
            justify-content: space-between;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .unit-container {
            width: 45%;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }
        .hp-bar {
            height: 12px;
            background: #ddd;
            border-radius: 6px;
            margin: 8px 0;
            overflow: hidden;
        }
        .hp {
            height: 100%;
            background: #4CAF50;
            transition: width 0.3s ease;
        }
        .energy-points {
            display: flex;
            gap: 8px;
            margin: 15px 0;
        }
        .energy-point {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e0e0e0;
            transition: all 0.2s ease;
        }
        .energy-point.active {
            background: #2196F3;
            box-shadow: 0 2px 4px rgba(33,150,243,0.3);
        }
        .energy-point.over {
            background: #ff5252;
        }
        #battle-log {
            height: 200px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow-y: auto;
        }
        .word-buttons {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }
        button.char-btn {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            position: relative;
        }
        button.char-btn.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }
        button.char-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        button.char-btn:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            margin-bottom: 5px;
        }
        #attack-btn {
            padding: 12px 24px;
            background: #FF5722;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }
        #attack-btn:disabled {
            background: #ffab91;
            cursor: not-allowed;
        }
        @keyframes attack {
            0% { transform: translateX(0); }
            30% { transform: translateX(30px); }
            70% { transform: translateX(-20px); }
            100% { transform: translateX(0); }
        }
        .attack-animation {
            animation: attack 0.4s;
        }
        .type-tag {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 15px;
            font-size: 12px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="score-board">å¾—åˆ†ï¼š<span id="score">0</span></div>
    
    <div class="battle-field">
        <div class="unit-container" id="player-unit">
            <div>HP: <strong id="player-hp">100</strong></div>
            <div class="hp-bar"><div id="player-hp-bar" class="hp"></div></div>
            <div>èƒ½é‡ç‚¹ï¼š</div>
            <div class="energy-points" id="player-energy"></div>
        </div>
        <div class="unit-container" id="enemy-unit">
            <div>
                HP: <strong id="enemy-hp">100</strong>
                <span id="enemy-type" class="type-tag">æ™®é€š</span>
            </div>
            <div class="hp-bar"><div id="enemy-hp-bar" class="hp"></div></div>
        </div>
    </div>

    <div id="battle-log"></div>
    <div class="word-buttons" id="word-buttons"></div>
    <button id="attack-btn" onclick="executeSkill()" disabled>å‘åŠ¨æŠ€èƒ½</button>

<script>
const CONFIG = {
    baseHP: 100,
    maxEnergy: 10
};

const TYPE_CHART = {
    // æ ¼å¼è¯´æ˜ï¼š
    // strong: æœ¬å±æ€§å…‹åˆ¶çš„å±æ€§åˆ—è¡¨ï¼ˆä¼¤å®³Ã—1.5ï¼‰
    // weak: æœ¬å±æ€§çš„å¼±ç‚¹å±æ€§åˆ—è¡¨ï¼ˆä¼¤å®³Ã—0.8ï¼‰
    // resist: æœ¬å±æ€§æŠµæŠ—çš„å±æ€§åˆ—è¡¨ï¼ˆå—åˆ°ä¼¤å®³Ã—0.8ï¼‰
    // ignore: æœ¬å±æ€§æ— è§†çš„å±æ€§åˆ—è¡¨ï¼ˆæ”»å‡»æ— æ•ˆï¼‰
    'æ™®é€š': { 
        strong: [],
        weak: ['æ ¼æ–—'],
        resist: [],
        ignore: ['å¹½çµ'] 
    },
    'åœ°': {
        strong: ['å²©','æ¯’','æ ¼æ–—','ç«','ç”µ'],
        weak: ['æ°´','è‰','å†°'],
        resist: ['å²©','æ¯’'],
        ignore: ['ç”µ']
    },
    'å²©': {
        strong: ['è™«','é£','ç«'],
        weak: ['åœ°','é’¢','æ ¼æ–—','æ°´','è‰','å†°'],
        resist: ['æ™®é€š','é£','ç«'],
        ignore: []
    },
    'é’¢': {
        strong: ['å²©','è™«'],
        weak: ['æ ¼æ–—','ç«'],
        resist: ['æ™®é€š','å²©','é’¢','è™«','å¹½çµ','é£','è¶…èƒ½','è‰','å†°','é¾™','æ¶'],
        ignore: ['æ¯’']
    },
    'æ¯’': {
        strong: ['è‰'],
        weak: ['åœ°','è¶…èƒ½'],
        resist: ['æ¯’','è™«','è‰'],
        ignore: []
    },
    'è™«': {
        strong: ['è¶…èƒ½','è‰','æ¶'],
        weak: ['å²©','é’¢','é£','ç«'],
        resist: ['åœ°','è™«','è‰'],
        ignore: []
    },
    'å¹½çµ': {
        strong: ['å¹½çµ','è¶…èƒ½'],
        weak: ['å¹½çµ','æ¶'],
        resist: [],
        ignore: ['æ™®é€š','æ ¼æ–—']
    },
    'é£': {
        strong: ['è™«','æ ¼æ–—','è‰'],
        weak: ['å²©','å†°','ç”µ'],
        resist: ['æ ¼æ–—','è™«','è‰'],
        ignore: ['åœ°']
    },
    'æ ¼æ–—': {
        strong: ['æ™®é€š','å²©','é’¢','å†°','æ¶'],
        weak: ['åœ°','é£','è¶…èƒ½'],
        resist: ['æ¶'],
        ignore: []
    },
    'è¶…èƒ½': {
        strong: ['æ¯’','æ ¼æ–—'],
        weak: ['è™«','å¹½çµ','æ¶'],
        resist: ['æ ¼æ–—','è¶…èƒ½'],
        ignore: []
    },
    'ç«': {
        strong: ['é’¢','è™«','è‰','å†°'],
        weak: ['åœ°','å²©','æ°´'],
        resist: ['é’¢','ç«','è‰','å†°'],
        ignore: []
    },
    'æ°´': {
        strong: ['åœ°','å²©','ç«'],
        weak: ['è‰','ç”µ'],
        resist: ['é’¢','ç«','å†°'],
        ignore: []
    },
    'è‰': {
        strong: ['åœ°','å²©','æ°´'],
        weak: ['æ¯’','è™«','é£','ç«','å†°'],
        resist: ['åœ°','æ°´','è‰','ç”µ'],
        ignore: []
    },
    'å†°': {
        strong: ['åœ°','å²©','é£','è‰','é¾™'],
        weak: ['æ ¼æ–—','ç«'],
        resist: ['é’¢','å†°'],
        ignore: []
    },
    'é¾™': {
        strong: ['é¾™'],
        weak: ['å†°','é¾™'],
        resist: ['æ ¼æ–—','ç«','æ°´','è‰','ç”µ'],
        ignore: []
    },
    'æ¶': {
        strong: ['å¹½çµ','è¶…èƒ½'],
        weak: ['è™«','æ ¼æ–—'],
        resist: ['å¹½çµ'],
        ignore: ['è¶…èƒ½']
    },
    'ç”µ': {
        strong: ['é£','æ°´'],
        weak: ['åœ°'],
        resist: ['é’¢','é£','ç”µ'],
        ignore: []
    }
};


// åœ¨TYPE_CHARTä¸­æ·»åŠ é¢œè‰²å±æ€§
const TYPE_COLORS = {
    'æ™®é€š': '#A8A878',
    'åœ°': '#E0C068',
    'å²©': '#B8A038',
    'é’¢': '#B8B8D0',
    'æ¯’': '#A040A0',
    'è™«': '#A8B820',
    'å¹½çµ': '#705898',
    'é£': '#A890F0',
    'æ ¼æ–—': '#C03028',
    'è¶…èƒ½': '#F85888',
    'ç«': '#F08030',
    'æ°´': '#6890F0',
    'è‰': '#78C850',
    'å†°': '#98D8D8',
    'é¾™': '#7038F8',
    'æ¶': '#705848',
    'ç”µ': '#F8D030'
};

Object.keys(TYPE_CHART).forEach(type => {
    TYPE_CHART[type].color = TYPE_COLORS[type];
});

const CHAR_EFFECTS = {
// å·²æœ‰çš„ä¾‹å­
'ç«': { types: [{type:'ç«', level: 1}], level: 1, cost: 1, tooltip: "ç«ç³»å¨åŠ›+1çº§" },
'ç‚': { types: [{type:'ç«', level: 2}], level: 2, cost: 2, tooltip: "ç«ç³»å¨åŠ›+2çº§" },
'ç„°': { types: [{type:'ç«', level: 3}], level: 3, cost: 3, tooltip: "ç«ç³»å¨åŠ›+3çº§" },
'æ°´': { types: [{type:'æ°´', level: 1}], level: 1, cost: 1, tooltip: "æ°´ç³»å¨åŠ›+1çº§" },
'é›·': { types: [{type:'ç”µ', level: 1}], level: 1, cost: 2, tooltip: "ç”µç³»å¨åŠ›+1çº§" },
'å²©': { types: [{type:'å²©', level: 1}], level: 1, cost: 2, tooltip: "å²©ç³»å¨åŠ›+1çº§" },
'é¾™': { types: [{type:'é¾™', level: 1}], level: 1, cost: 3, tooltip: "é¾™ç³»å¨åŠ›+1çº§" },
// æ–°å¢çš„æ™®é€šç³»
'å‡¡': { types: [{type:'æ™®é€š', level: 1}], level: 1, cost: 1, tooltip: "æ™®é€šç³»å¨åŠ›+1çº§" },
'å¸¸': { types: [{type:'æ™®é€š', level: 2}], level: 2, cost: 2, tooltip: "æ™®é€šç³»å¨åŠ›+2çº§" },
'åº¸': { types: [{type:'æ™®é€š', level: 3}], level: 3, cost: 3, tooltip: "æ™®é€šç³»å¨åŠ›+3çº§" },
// åœ°ç³»
'åœ°': { types: [{type:'åœ°', level: 1}], level: 1, cost: 1, tooltip: "åœ°ç³»å¨åŠ›+1çº§" },
'éœ‡': { types: [{type:'åœ°', level: 2}], level: 2, cost: 2, tooltip: "åœ°ç³»å¨åŠ›+2çº§" },
'å¤': { types: [{type:'åœ°', level: 3}], level: 3, cost: 3, tooltip: "åœ°ç³»å¨åŠ›+3çº§" },
// å²©ç³»å·²å­˜åœ¨ï¼Œè¡¥å……é«˜çº§
'ç£Š': { types: [{type:'å²©', level: 2}], level: 2, cost: 3, tooltip: "å²©ç³»å¨åŠ›+2çº§" },
'ç£': { types: [{type:'å²©', level: 3}], level: 3, cost: 4, tooltip: "å²©ç³»å¨åŠ›+3çº§" },
// é’¢ç³»
'é’¢': { types: [{type:'é’¢', level: 1}], level: 1, cost: 2, tooltip: "é’¢ç³»å¨åŠ›+1çº§" },
'é“': { types: [{type:'é’¢', level: 2}], level: 2, cost: 3, tooltip: "é’¢ç³»å¨åŠ›+2çº§" },
'é“¬': { types: [{type:'é’¢', level: 3}], level: 3, cost: 4, tooltip: "é’¢ç³»å¨åŠ›+3çº§" },
// æ¯’ç³»
'æ¯’': { types: [{type:'æ¯’', level: 1}], level: 1, cost: 1, tooltip: "æ¯’ç³»å¨åŠ›+1çº§" },
'ç˜´': { types: [{type:'æ¯’', level: 2}], level: 2, cost: 2, tooltip: "æ¯’ç³»å¨åŠ›+2çº§" },
'è›Š': { types: [{type:'æ¯’', level: 3}], level: 3, cost: 3, tooltip: "æ¯’ç³»å¨åŠ›+3çº§" },
// è™«ç³»
'è™«': { types: [{type:'è™«', level: 1}], level: 1, cost: 1, tooltip: "è™«ç³»å¨åŠ›+1çº§" },
'èœ•': { types: [{type:'è™«', level: 2}], level: 2, cost: 2, tooltip: "è™«ç³»å¨åŠ›+2çº§" },
'è›°': { types: [{type:'è™«', level: 3}], level: 3, cost: 3, tooltip: "è™«ç³»å¨åŠ›+3çº§" },
// å¹½çµç³»
'å¹½': { types: [{type:'å¹½çµ', level: 1}], level: 1, cost: 2, tooltip: "å¹½çµç³»å¨åŠ›+1çº§" },
'å†¥': { types: [{type:'å¹½çµ', level: 2}], level: 2, cost: 3, tooltip: "å¹½çµç³»å¨åŠ›+2çº§" },
'é­‚': { types: [{type:'å¹½çµ', level: 3}], level: 3, cost: 4, tooltip: "å¹½çµç³»å¨åŠ›+3çº§" },
// é£è¡Œç³»
'é£': { types: [{type:'é£', level: 1}], level: 1, cost: 1, tooltip: "é£è¡Œç³»å¨åŠ›+1çº§" },
'ç¿”': { types: [{type:'é£', level: 2}], level: 2, cost: 2, tooltip: "é£è¡Œç³»å¨åŠ›+2çº§" },
'ç¿±': { types: [{type:'é£', level: 3}], level: 3, cost: 3, tooltip: "é£è¡Œç³»å¨åŠ›+3çº§" },
// æ ¼æ–—ç³»
'æ–—': { types: [{type:'æ ¼æ–—', level: 1}], level: 1, cost: 1, tooltip: "æ ¼æ–—ç³»å¨åŠ›+1çº§" },
'æ­¦': { types: [{type:'æ ¼æ–—', level: 2}], level: 2, cost: 2, tooltip: "æ ¼æ–—ç³»å¨åŠ›+2çº§" },
'æˆ˜': { types: [{type:'æ ¼æ–—', level: 3}], level: 3, cost: 3, tooltip: "æ ¼æ–—ç³»å¨åŠ›+3çº§" },
// è¶…èƒ½ç³»
'å¿µ': { types: [{type:'è¶…èƒ½', level: 1}], level: 1, cost: 2, tooltip: "è¶…èƒ½ç³»å¨åŠ›+1çº§" },
'çµ': { types: [{type:'è¶…èƒ½', level: 2}], level: 2, cost: 3, tooltip: "è¶…èƒ½ç³»å¨åŠ›+2çº§" },
'ç¥': { types: [{type:'è¶…èƒ½', level: 3}], level: 3, cost: 4, tooltip: "è¶…èƒ½ç³»å¨åŠ›+3çº§" },
// è‰ç³»
'è‰': { types: [{type:'è‰', level: 1}], level: 1, cost: 1, tooltip: "è‰ç³»å¨åŠ›+1çº§" },
'è”“': { types: [{type:'è‰', level: 2}], level: 2, cost: 2, tooltip: "è‰ç³»å¨åŠ›+2çº§" },
'æ£®': { types: [{type:'è‰', level: 3}], level: 3, cost: 3, tooltip: "è‰ç³»å¨åŠ›+3çº§" },
// å†°ç³»
'å†°': { types: [{type:'å†°', level: 1}], level: 1, cost: 2, tooltip: "å†°ç³»å¨åŠ›+1çº§" },
'éœœ': { types: [{type:'å†°', level: 2}], level: 2, cost: 3, tooltip: "å†°ç³»å¨åŠ›+2çº§" },
'å¯’': { types: [{type:'å†°', level: 3}], level: 3, cost: 4, tooltip: "å†°ç³»å¨åŠ›+3çº§" },
// é¾™ç³»è¡¥å……é«˜çº§
'ç…Œ': { types: [{type:'é¾™', level: 2}], level: 2, cost: 4, tooltip: "é¾™ç³»å¨åŠ›+2çº§" },
'éœ¸': { types: [{type:'é¾™', level: 3}], level: 3, cost: 5, tooltip: "é¾™ç³»å¨åŠ›+3çº§" },
// æ¶ç³»
'æ¶': { types: [{type:'æ¶', level: 1}], level: 1, cost: 2, tooltip: "æ¶ç³»å¨åŠ›+1çº§" },
'é‚ª': { types: [{type:'æ¶', level: 2}], level: 2, cost: 3, tooltip: "æ¶ç³»å¨åŠ›+2çº§" },
'æš—': { types: [{type:'æ¶', level: 3}], level: 3, cost: 4, tooltip: "æ¶ç³»å¨åŠ›+3çº§" },
// ç”µç³»è¡¥å……é«˜çº§
'éœ†': { types: [{type:'ç”µ', level: 2}], level: 2, cost: 3, tooltip: "ç”µç³»å¨åŠ›+2çº§" },
'éœ¹': { types: [{type:'ç”µ', level: 3}], level: 3, cost: 4, tooltip: "ç”µç³»å¨åŠ›+3çº§" },
};


// æ·»åŠ é»˜è®¤ç±»å‹é…ç½®é˜²æ­¢æœªå®šä¹‰é”™è¯¯
const DEFAULT_TYPE_INFO = {
    strong: [],
    weak: [],
    resist: [],
    ignore: [],
    color: '#999'
};

let gameState = {
    player: { hp: 1000, energy: 10 },
    enemy: { hp: 100, type: 'æ™®é€š' },
    selectedChars: [],
    score: 0,
    currentSkills: [] // æ–°å¢ï¼šå½“å‰å¯ç”¨çš„æŠ€èƒ½å­—ç¬¦
};

function initGame() {
    generateEnemy();
    generateRandomSkills(); // ç”Ÿæˆåˆå§‹æŠ€èƒ½
    renderWordButtons();
    updateAllDisplays();
}

// ç”ŸæˆéšæœºæŠ€èƒ½æ± 
function generateRandomSkills() {
    const allSkills = Object.keys(CHAR_EFFECTS);
    // æ´—ç‰Œç®—æ³•æŠ½å–12ä¸ª
    gameState.currentSkills = allSkills
        .sort(() => Math.random() - 0.5)
        .slice(0, 12);
    // æ¸…ç©ºå·²é€‰æŠ€èƒ½
    gameState.selectedChars = [];
}

function generateEnemy() {
    const types = Object.keys(TYPE_CHART);
    gameState.enemy = {
        hp: 100,
        type: types[Math.floor(Math.random() * types.length)],
        maxHP: 100
    };
}

function updateAllDisplays() {
    // æ›´æ–°ç©å®¶çŠ¶æ€
    document.getElementById('player-hp').textContent = gameState.player.hp;
    document.getElementById('player-hp-bar').style.width = `${(gameState.player.hp / CONFIG.baseHP) * 100}%`;
    
    // æ›´æ–°æ•ŒäººçŠ¶æ€
    document.getElementById('enemy-hp').textContent = gameState.enemy.hp;
    document.getElementById('enemy-hp-bar').style.width = `${(gameState.enemy.hp / CONFIG.baseHP) * 100}%`;

    
    const typeTag = document.getElementById('enemy-type');
    typeTag.style.backgroundColor = TYPE_CHART[gameState.enemy.type]?.color || '#777';
    typeTag.style.textShadow = '1px 1px 2px rgba(0,0,0,0.3)';
    typeTag.textContent = gameState.enemy.type;

    // æ›´æ–°èƒ½é‡ç‚¹
    const totalCost = gameState.selectedChars.reduce((sum, c) => sum + CHAR_EFFECTS[c].cost, 0);
    const energyContainer = document.getElementById('player-energy');
    energyContainer.innerHTML = Array(CONFIG.maxEnergy).fill().map((_, i) => 
        `<div class="energy-point ${i < gameState.player.energy ? 'active' : ''} ${i >= (gameState.player.energy - totalCost) ? 'over' : ''}"></div>`
    ).join('');

    // æ›´æ–°å¾—åˆ†
    document.getElementById('score').textContent = gameState.score;

    const attackBtn = document.getElementById('attack-btn');
    attackBtn.disabled = false

}

function renderWordButtons() {
   const container = document.getElementById('word-buttons');
    const totalCost = gameState.selectedChars.reduce((sum, c) => sum + CHAR_EFFECTS[c].cost, 0);
    
    container.innerHTML = gameState.currentSkills.map(char => {
        const isSelected = gameState.selectedChars.includes(char);
        const canSelect = (totalCost + CHAR_EFFECTS[char].cost) <= gameState.player.energy;
        
        return `
            <button class="char-btn ${isSelected ? 'selected' : ''}"
                data-tooltip="${CHAR_EFFECTS[char].tooltip}"
                onclick="toggleChar('${char}')"
                ${isSelected || canSelect ? '' : 'disabled'}>
                ${char}ï¼ˆ${CHAR_EFFECTS[char].cost}ï¼‰
            </button>
        `;
    }).join('');
}

function toggleChar(char) {
    const index = gameState.selectedChars.indexOf(char);
    if (index > -1) {
        gameState.selectedChars.splice(index, 1);
    } else {
        const newCost = gameState.selectedChars.reduce((sum, c) => sum + CHAR_EFFECTS[c].cost, 0) + CHAR_EFFECTS[char].cost;
        if (newCost > CONFIG.maxEnergy) {
            alert("èƒ½é‡ä¸è¶³ï¼");
            return;
        }
        gameState.selectedChars.push(char);
    }
    renderWordButtons();
    updateAllDisplays();
}

function executeSkill() {
    const skillName = gameState.selectedChars.join('');
    const result = calculateDamage();
    

    // è®°å½•æ—¥å¿—
    let logMessage = `ä½¿ç”¨ ${skillName} é€ æˆ ${result.damage} ä¼¤å®³`;
    if (result.effect) {
        logMessage += ` ${result.effect}`;
    }
    log(logMessage);
    
    // æ›´æ–°æ•ŒäººHP
    gameState.enemy.hp = Math.max(0, gameState.enemy.hp - result.damage);
    
    // æ£€æŸ¥æ˜¯å¦å‡»è´¥æ•Œäºº
    if (gameState.enemy.hp <= 0) {
        gameState.score++;
        log("ğŸ‰ å‡»è´¥æ•Œäººï¼è·å¾—1åˆ†");
        generateEnemy();
        gameState.player.energy = CONFIG.maxEnergy;
    }
    
    const playerElem = document.getElementById('player-unit');
    playerElem.classList.add('attack-animation');
    setTimeout(() => {
        playerElem.classList.remove('attack-animation');
        updateAllDisplays(); 
    }, 500);

    setTimeout(() => {
        enemyAttack();
        generateRandomSkills();
    }, 1000);
    
}

function calculateDamage() {
    let totalDamage = 0;
    const effects = new Set();
    const typeLevels = {}; // ä¿®å¤ï¼šåˆå§‹åŒ–ç±»å‹ç­‰çº§å®¹å™¨

    // ç¬¬ä¸€æ­¥ï¼šæ”¶é›†æ‰€æœ‰æŠ€èƒ½ç±»å‹ç­‰çº§
    gameState.selectedChars.forEach(char => {
        const effect = CHAR_EFFECTS[char];
        effect.types.forEach(({ type, level }) => {
            if (!typeLevels[type]) typeLevels[type] = [];
            
            // æ’å…¥å¹¶æ’åºï¼Œä¿ç•™æœ€é«˜ä¸¤ä¸ªç­‰çº§
            typeLevels[type].push(level);
            typeLevels[type].sort((a, b) => b - a);
            if (typeLevels[type].length > 2) {
                typeLevels[type].pop(); // ç§»é™¤æœ€ä½ç­‰çº§
            }
        });
    });

    // ç¬¬äºŒæ­¥ï¼šè®¡ç®—æ¯ä¸ªç±»å‹çš„ä¼¤å®³
    Object.entries(typeLevels).forEach(([type, levels]) => {
        const totalLevel = levels.reduce((a, b) => a + b, 0);
        let damage = totalLevel * 10;
        const multiplier = calculateMultiplier(type, gameState.enemy.type);

        // è®°å½•æ•ˆæœç±»å‹
        if (multiplier === 0) {
            effects.add('immune');
        } else if (multiplier > 1) {
            effects.add('super');
        } else if (multiplier < 1) {
            effects.add('not_very');
        }

        totalDamage += Math.floor(damage * multiplier);
    });

    // ç¡®å®šæœ€ç»ˆæç¤º
    let effectText = '';
    if (effects.has('immune')) {
        effectText = 'æ•ˆæœæ— æ•ˆ';
    } else if (effects.has('super')) {
        effectText = 'ååˆ†æœ‰æ•ˆï¼';
    } else if (effects.has('not_very')) {
        effectText = 'æ•ˆæœå¾®å¼±';
    }
    
    return { damage: totalDamage, effect: effectText };
}


function calculateMultiplier(attackType, defendType) {
 // é˜²å¾¡æ€§æ£€æŸ¥
    const attackInfo = TYPE_CHART[attackType] || DEFAULT_TYPE_INFO;
    const defendInfo = TYPE_CHART[defendType] || DEFAULT_TYPE_INFO;

    // å¤„ç†æ— è§†è§„åˆ™ï¼ˆå®‰å…¨è®¿é—®å±æ€§ï¼‰
    const attackIgnore = attackInfo.ignore || [];
    const defendIgnore = defendInfo.ignore || [];
    if (attackIgnore.includes(defendType) || defendIgnore.includes(attackType)) {
        return 0;
    }

    let multiplier = 1;

    // å¤„ç†å…‹åˆ¶å…³ç³»ï¼ˆå®‰å…¨è®¿é—®æ•°ç»„ï¼‰
    const attackStrong = attackInfo.strong || [];
    const defendWeak = defendInfo.weak || [];
    if (attackStrong.includes(defendType) || defendWeak.includes(attackType)) {
        multiplier *= 1.5;
    }

    // å¤„ç†æŠµæŠ—å…³ç³»ï¼ˆå®‰å…¨è®¿é—®æ•°ç»„ï¼‰
    const attackWeak = attackInfo.weak || [];
    const defendResist = defendInfo.resist || [];
    if (attackWeak.includes(defendType) || defendResist.includes(attackType)) {
        multiplier *= 0.8;
    }

    return multiplier;
}

function enemyAttack() {

    const playerElem = document.getElementById('enemy-unit');
    playerElem.classList.add('attack-animation');
    setTimeout(() => {
        playerElem.classList.remove('attack-animation');
        const damage = 15 + Math.floor(Math.random() * 10);
        gameState.player.hp = Math.max(0, gameState.player.hp - damage);
        log(`ğŸ’¥ æ•Œäººæ”»å‡»é€ æˆ ${damage} ä¼¤å®³`);
        
        gameState.selectedChars = [];
        renderWordButtons();
        updateAllDisplays(); 
    }, 500);    
}

function log(message) {
    const logElement = document.getElementById('battle-log');
    const coloredMessage = applyColorTags(message);
    logElement.innerHTML += `<div>ğŸ•’ ${new Date().toLocaleTimeString()} - ${coloredMessage}</div>`;
    logElement.scrollTop = logElement.scrollHeight;
}

function applyColorTags(text) {
    const charMap = Object.keys(CHAR_EFFECTS).reduce((acc, char) => {
        const type = CHAR_EFFECTS[char].types[0]; // å–ç¬¬ä¸€ä¸ªç±»å‹
        acc[char] = TYPE_CHART[type]?.color || '#666';
        return acc;
    }, {});
    
    return text.split('').map(char => {
        const color = charMap[char] || '#666';
        return `<span style="color:${color};font-weight:bold">${char}</span>`;
    }).join('');
}

// å¯åŠ¨æ¸¸æˆ
initGame();

// å¢å¼ºCHAR_EFFECTSé…ç½®éªŒè¯
function validateConfig() {
    Object.entries(CHAR_EFFECTS).forEach(([char, config]) => {
        config.types.forEach(typeObj => {
            if (!TYPE_CHART[typeObj.type]) {
                console.error(`é…ç½®é”™è¯¯ï¼šå­—ç¬¦"${char}"ä½¿ç”¨äº†æœªå®šä¹‰çš„ç±»å‹"${typeObj.type}"`);
            }
        });
    });
}

// åˆå§‹åŒ–æ—¶æ‰§è¡Œé…ç½®éªŒè¯
validateConfig();
</script>
</body>
</html>